#image: sbtscala/scala-sbt:eclipse-temurin-17.0.15_6_1.12.1_3.8.1
#
#variables:
#  # Reduce memory usage for sbt
#  SBT_OPTS: "-Xmx2G -Dfile.encoding=UTF-8"
#
## Workflow-level rules: auto-run on master, manual trigger on other branches
#workflow:
#  rules:
#    - if: '$CI_COMMIT_BRANCH == "master"'
#      when: always
#    - if: $CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api"
#      when: always  # Run pipeline for these sources
#
#stages:
#  - lint
#  - compile
#  - test
#  - coverage-report
#  - static-analysis
#
## Cache downloaded dependencies and sbt artifacts using the build.sbt checksum as key
#cache:
#  key:
#    files:
#      - build.sbt
#  paths:
#    - .cache/coursier
#    - .sbt
#
#lint:
#  stage: lint
#  script:
#    - sbt scalafmtCheckAll scalafmtSbtCheck
#
## Compile jobs (run in parallel)
#compile:core:
#  stage: compile
#  script:
#    - sbt core/compile
#
#compile:dsl:
#  stage: compile
#  script:
#    - sbt dsl/compile
#
#compile:engineApi:
#  stage: compile
#  script:
#    - sbt engineApi/compile
#
#compile:storage:
#  stage: compile
#  script:
#    - sbt storage/compile
#
#compile:engine:
#  stage: compile
#  script:
#    - sbt engine/compile
#
##compile:executor:
##  stage: compile
##  script:
##    - sbt executor/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##compile:observability:
##  stage: compile
##  script:
##    - sbt observability/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##compile:security:
##  stage: compile
##  script:
##    - sbt security/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##compile:api:
##  stage: compile
##  script:
##    - sbt api/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##compile:server:
##  stage: compile
##  script:
##    - sbt server/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##compile:cli:
##  stage: compile
##  script:
##    - sbt cli/compile
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
#
## Test jobs (run in parallel, depend on their respective compile jobs)
#test:core:
#  stage: test
#  script:
#    - sbt coverage core/test coverageReport
#  dependencies:
#    - compile:core
#  artifacts:
#    when: always
#    paths:
#      - modules/core/target/test-reports/
#      - modules/core/target/scala-3.8.1/scoverage-report/
#      - modules/core/target/scala-3.8.1/scoverage-data/
#    reports:
#      junit: modules/core/target/test-reports/*.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: modules/core/target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
#
#test:dsl:
#  stage: test
#  script:
#    - sbt coverage dsl/test coverageReport
#  dependencies:
#    - compile:dsl
#  artifacts:
#    when: always
#    paths:
#      - modules/dsl/target/test-reports/
#      - modules/dsl/target/scala-3.8.1/scoverage-report/
#      - modules/dsl/target/scala-3.8.1/scoverage-data/
#    reports:
#      junit: modules/dsl/target/test-reports/*.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: modules/dsl/target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
#
#test:engineApi:
#  stage: test
#  script:
#    - sbt coverage engineApi/test coverageReport
#  dependencies:
#    - compile:engineApi
#  artifacts:
#    when: always
#    paths:
#      - modules/engine-api/target/test-reports/
#      - modules/engine-api/target/scala-3.8.1/scoverage-report/
#      - modules/engine-api/target/scala-3.8.1/scoverage-data/
#    reports:
#      junit: modules/engine-api/target/test-reports/*.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: modules/engine-api/target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
#
#test:storage:
#  stage: test
#  services:
#    - docker:27-dind
#  variables:
#    # Docker-in-Docker configuration
#    DOCKER_HOST: tcp://docker:2375
#    DOCKER_TLS_CERTDIR: ""
#    DOCKER_DRIVER: overlay2
#    # Testcontainers configuration
#    TESTCONTAINERS_RYUK_DISABLED: "true"
#    TESTCONTAINERS_CHECKS_DISABLE: "true"
#  script:
#    - sbt coverage storage/test coverageReport
#  dependencies:
#    - compile:storage
#  artifacts:
#    when: always
#    paths:
#      - modules/storage/target/test-reports/
#      - modules/storage/target/scala-3.8.1/scoverage-report/
#      - modules/storage/target/scala-3.8.1/scoverage-data/
#    reports:
#      junit: modules/storage/target/test-reports/*.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: modules/storage/target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
#
#test:engine:
#  stage: test
#  script:
#    - sbt coverage engine/test coverageReport
#  dependencies:
#    - compile:engine
#  artifacts:
#    when: always
#    paths:
#      - modules/engine/target/test-reports/
#      - modules/engine/target/scala-3.8.1/scoverage-report/
#      - modules/engine/target/scala-3.8.1/scoverage-data/
#    reports:
#      junit: modules/engine/target/test-reports/*.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: modules/engine/target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
#
##test:executor:
##  stage: test
##  script:
##    - sbt executor/test
##  dependencies:
##    - compile:executor
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##test:observability:
##  stage: test
##  script:
##    - sbt observability/test
##  dependencies:
##    - compile:observability
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##test:security:
##  stage: test
##  script:
##    - sbt security/test
##  dependencies:
##    - compile:security
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##test:api:
##  stage: test
##  script:
##    - sbt api/test
##  dependencies:
##    - compile:api
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##test:server:
##  stage: test
##  script:
##    - sbt server/test
##  dependencies:
##    - compile:server
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
##
##test:cli:
##  stage: test
##  script:
##    - sbt cli/test
##  dependencies:
##    - compile:cli
##  rules:
##    - if: '$CI_COMMIT_BRANCH == "master"'
##    - when: manual
#
#static_analysis:
#  stage: static-analysis
#  script:
#    - sbt "scalafixAll --check"
#
## Aggregate coverage report (combines coverage from all modules)
#coverage_aggregate:
#  stage: coverage-report
#  dependencies:
#    - test:core
#    - test:dsl
#    - test:engineApi
#    - test:storage
#    - test:engine
#  script:
#    - sbt coverageAggregate coverageReport
#  artifacts:
#    when: always
#    paths:
#      - target/scala-3.8.1/scoverage-report/
#    reports:
#      coverage_report:
#        coverage_format: cobertura
#        path: target/scala-3.8.1/coverage-report/cobertura.xml
#    expire_in: 30 days
#  coverage: '/Statement coverage[A-Za-z\s\.\:]+\s(\d+\.\d+)%/'
workflow:
  rules:
    - when: never

stages:
  - noop

noop-job:
  stage: noop
  script:
    - echo "This will never run"
  rules:
    - when: never    