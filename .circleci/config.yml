version: 2.1

# Define executors
executors:
  scala-executor:
    docker:
      - image: sbtscala/scala-sbt:eclipse-temurin-17.0.15_6_1.12.1_3.8.1
    environment:
      SBT_OPTS: "-Xmx2G -Dfile.encoding=UTF-8"
      TESTCONTAINERS_RYUK_DISABLED: "true"
      TESTCONTAINERS_CHECKS_DISABLE: "true"
    resource_class: medium

jobs:
  lint:
    executor: scala-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - sbt-cache-{{ checksum "build.sbt" }}
            - sbt-cache-
      - run:
          name: Check code formatting
          command: sbt scalafmtCheckAll scalafmtSbtCheck
      - run:
          name: Run static analysis with Scalafix
          command: sbt "scalafixAll --check"

  build-and-test:
    executor: scala-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - restore_cache:
          keys:
            - sbt-cache-{{ checksum "build.sbt" }}
            - sbt-cache-

      # Compile all modules together (respects dependencies)
      - run:
          name: Compile all modules
          command: sbt compile

      # Run all tests with coverage in one go
      - run:
          name: Run all tests with coverage
          command: sbt coverage test coverageReport coverageAggregate

      # Store test results
      - store_test_results:
          path: modules/core/target/test-reports
      - store_test_results:
          path: modules/dsl/target/test-reports
      - store_test_results:
          path: modules/engine-api/target/test-reports
      - store_test_results:
          path: modules/storage/target/test-reports
      - store_test_results:
          path: modules/engine/target/test-reports

      # Store test artifacts
      - store_artifacts:
          path: modules/core/target/test-reports
          destination: test-reports/core
      - store_artifacts:
          path: modules/dsl/target/test-reports
          destination: test-reports/dsl
      - store_artifacts:
          path: modules/engine-api/target/test-reports
          destination: test-reports/engine-api
      - store_artifacts:
          path: modules/storage/target/test-reports
          destination: test-reports/storage
      - store_artifacts:
          path: modules/engine/target/test-reports
          destination: test-reports/engine

      # Store coverage reports
      - store_artifacts:
          path: target/scala-3.8.1/scoverage-report
          destination: coverage-reports/aggregate
      - store_artifacts:
          path: target/scala-3.8.1/coverage-report/cobertura.xml
          destination: coverage-reports/cobertura.xml

      # Save cache once at the end
      - save_cache:
          key: sbt-cache-{{ checksum "build.sbt" }}
          paths:
            - ~/.cache/coursier
            - ~/.sbt
            - ~/.ivy2/cache

  coverage-aggregate:
    executor: scala-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - sbt-cache-{{ checksum "build.sbt" }}
            - sbt-cache-
      - attach_workspace:
          at: .
      - run:
          name: Aggregate all coverage reports
          command: sbt coverageAggregate
      - store_artifacts:
          path: target/scala-3.8.1/scoverage-report
          destination: coverage-reports/aggregate-final
      - store_artifacts:
          path: target/scala-3.8.1/coverage-report/cobertura.xml
          destination: coverage-reports/cobertura-final.xml

# Single optimized workflow
workflows:
  version: 2
  build:
    jobs:
      - lint

      - build-and-test:
          requires:
            - lint

      # Aggregate coverage from both jobs
      - coverage-aggregate:
          requires:
            - build-and-test